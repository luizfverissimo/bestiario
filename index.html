<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bestiário Shadowdark RPG</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f5f5f5;
            color: #333;
        }
        
        .header-title {
            font-weight: 700;
            letter-spacing: -0.025em;
        }
        
        .monster-card {
            background: white;
            border: 1px solid #e0e0e0;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
            transition: all 0.2s ease;
        }
        
        .monster-card:hover {
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        
        .favorite {
            border-left: 4px solid #333;
        }
        
        .combat-section {
            background: white;
            border: 1px solid #e0e0e0;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
        }
        
        .combat-monster {
            border-bottom: 1px solid #eee;
        }
        
        .hp-control {
            background: #f8f8f8;
            border: 1px solid #ddd;
        }
        
        .btn-black {
            background: #000;
            color: white;
            border: none;
            transition: all 0.2s ease;
        }
        
        .btn-black:hover {
            background: #333;
        }
        
        .btn-outline {
            background: white;
            color: #333;
            border: 1px solid #ddd;
            transition: all 0.2s ease;
        }
        
        .btn-outline:hover {
            background: #f8f8f8;
        }
        
        .attack-btn {
            background: #f0f0f0;
            border: 1px solid #ddd;
            transition: all 0.2s ease;
        }
        
        .attack-btn:hover {
            background: #e0e0e0;
        }
        
        .special-ability {
            background: #f8f8f8;
            border-left: 2px solid #333;
        }
        
        .dice-roll {
            animation: roll 0.5s ease-out;
        }
        
        @keyframes roll {
            0% { transform: rotate(0deg); }
            25% { transform: rotate(90deg); }
            50% { transform: rotate(180deg); }
            75% { transform: rotate(270deg); }
            100% { transform: rotate(360deg); }
        }
        
        .stat-circle {
            background: white;
            border: 1px solid #333;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .stat-circle:hover {
            background: #f0f0f0;
            transform: scale(1.05);
        }
        
        .form-section {
            background: white;
            border: 1px solid #e0e0e0;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
        }
        
        .dice-result-box {
            background: white;
            border: 1px solid #333;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        
        .dice-value {
            font-weight: 700;
            font-size: 2rem;
        }
        
        .dice-total {
            font-weight: 800;
            font-size: 2.5rem;
            color: #000;
        }
        
        .scroll-container {
            max-height: 65vh;
            overflow-y: auto;
        }
        
        .section-title {
            font-weight: 700;
            letter-spacing: -0.015em;
            border-bottom: 2px solid #333;
            padding-bottom: 0.25rem;
        }
        
        .monster-name {
            font-weight: 700;
            letter-spacing: -0.015em;
        }
        
        .attribute-label {
            font-weight: 500;
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }
        
        .attack-name {
            font-weight: 600;
        }
        
        .monster-level {
            font-size: 0.8rem;
            letter-spacing: 0.05em;
        }
        
        input, select, textarea {
            border: 1px solid #ddd;
            background: white;
        }
        
        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: #999;
        }
        
        .combat-header {
            background: #000;
            color: white;
        }
        
        .combat-badge {
            background: #000;
            color: white;
        }
        
        .combat-indicator {
            background: #000;
            color: white;
            font-size: 0.7rem;
            padding: 2px 6px;
            border-radius: 4px;
        }
        
        .combat-actions {
            display: flex;
            gap: 4px;
            margin-top: 8px;
        }
        
        .attack-dropdown {
            position: relative;
            display: inline-block;
        }
        
        .attack-dropdown-content {
            display: none;
            position: absolute;
            background-color: white;
            min-width: 160px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            z-index: 1;
            border: 1px solid #ddd;
            border-radius: 4px;
            overflow: hidden;
        }
        
        .attack-dropdown-content a {
            color: #333;
            padding: 8px 12px;
            text-decoration: none;
            display: block;
            font-size: 0.9rem;
            border-bottom: 1px solid #eee;
        }
        
        .attack-dropdown-content a:hover {
            background-color: #f0f0f0;
        }
        
        .attack-dropdown:hover .attack-dropdown-content {
            display: block;
        }
        
        .monster-actions {
            display: flex;
            gap: 8px;
            margin-top: 12px;
        }
        
        .edit-btn {
            color: #333;
        }
        
        .edit-btn:hover {
            color: #1a73e8;
        }
        
        .delete-btn {
            color: #333;
        }
        
        .delete-btn:hover {
            color: #d93025;
        }
        
        .combat-instance-id {
            font-size: 0.75rem;
            color: #666;
            margin-left: 4px;
        }
        
        .remove-attack-btn {
            color: #d93025;
            display: flex;
            align-items: center;
            justify-content: center;
            height: 100%;
            padding: 0 8px;
            cursor: pointer;
        }
        
        .remove-attack-btn:hover {
            background: #f8f8f8;
        }
        
        .attribute-roll-result {
            font-size: 1.8rem;
            font-weight: 700;
            text-align: center;
            margin-top: 8px;
        }
    </style>
</head>
<body class="min-h-screen">
    <div class="container mx-auto px-4 py-8 max-w-6xl">
        <!-- Cabeçalho -->
        <header class="text-center mb-10">
            <h1 class="text-3xl md:text-4xl mb-2 header-title">
                BESTIÁRIO SHADOWDARK RPG
            </h1>
            <p class="text-gray-600 max-w-2xl mx-auto">
                Gerencie criaturas para suas aventuras - role dados e controle combates
            </p>
        </header>
        <!-- Botões de Exportar/Importar Monstros -->
        <div class="flex justify-end gap-2 mb-4">
            <button id="exportBtn" class="btn-outline py-2 px-4 rounded flex items-center">
                <i class="fas fa-file-export mr-2"></i> Exportar Monstros
            </button>
            <input type="file" id="importInput" accept="application/json" style="display:none" />
            <button id="importBtn" class="btn-outline py-2 px-4 rounded flex items-center">
                <i class="fas fa-file-import mr-2"></i> Importar Monstros
            </button>
        </div>

        <!-- Barra de busca e controles -->
        <div class="flex flex-col md:flex-row justify-between items-center mb-8 gap-4">
            <div class="relative w-full md:w-2/5">
                <input 
                    type="text" 
                    id="search" 
                    placeholder="Buscar monstro..." 
                    class="w-full p-3 rounded border border-gray-300 focus:outline-none pl-10"
                >
                <i class="fas fa-search absolute left-3 top-3.5 text-gray-500"></i>
            </div>
            
            <div class="flex gap-2">
                <button id="show-form-btn" class="btn-black py-2 px-4 rounded flex items-center">
                    <i class="fas fa-plus mr-2"></i> Novo Monstro
                </button>
                <button id="toggle-favorites" class="btn-black py-2 px-4 rounded flex items-center">
                    <i class="fas fa-star mr-2"></i> Favoritos
                </button>
            </div>
        </div>

        <!-- Formulário para adicionar/editar monstros -->
        <div id="monster-form-container" class="hidden mb-10 form-section rounded p-6">
            <h2 class="text-xl font-bold mb-6 section-title" id="form-title">
                ADICIONAR NOVO MONSTRO
            </h2>
            
            <form id="monster-form" class="grid grid-cols-1 md:grid-cols-2 gap-6 p-6 rounded">
                <input type="hidden" id="edit-id" name="edit-id">
                
                <div>
                    <label class="block mb-2 font-bold">Nome</label>
                    <input type="text" name="name" required class="w-full p-2 rounded border border-gray-300">
                </div>
                
                <div>
                    <label class="block mb-2 font-bold">Descrição</label>
                    <textarea name="description" rows="2" class="w-full p-2 rounded border border-gray-300"></textarea>
                </div>
                
                <div>
                    <label class="block mb-2 font-bold">Classe de Armadura (AC)</label>
                    <input type="number" name="ac" required class="w-full p-2 rounded border border-gray-300">
                </div>
                
                <div>
                    <label class="block mb-2 font-bold">Pontos de Vida (HP)</label>
                    <input type="number" name="hp" required class="w-full p-2 rounded border border-gray-300">
                </div>
                
                <div>
                    <label class="block mb-2 font-bold">Nível (LV)</label>
                    <input type="number" name="lv" required class="w-full p-2 rounded border border-gray-300">
                </div>
                
                <div>
                    <label class="block mb-2 font-bold">Alinhamento (AL)</label>
                    <select name="al" class="w-full p-2 rounded border border-gray-300">
                        <option value="N">Neutro</option>
                        <option value="L">Leal</option>
                        <option value="C">Caótico</option>
                        <option value="B">Bom</option>
                        <option value="M">Mal</option>
                    </select>
                </div>
                
                <div>
                    <label class="block mb-2 font-bold">Movimento (MV)</label>
                    <input type="text" name="mv" required class="w-full p-2 rounded border border-gray-300">
                </div>
                
                <div class="md:col-span-2">
                    <h3 class="text-lg font-bold mb-3 section-title">ATRIBUTOS</h3>
                    <div class="grid grid-cols-3 sm:grid-cols-6 gap-4">
                        <div>
                            <label class="block mb-2">Força (S)</label>
                            <input type="number" name="S" required class="w-full p-2 rounded border border-gray-300">
                        </div>
                        <div>
                            <label class="block mb-2">Destreza (D)</label>
                            <input type="number" name="D" required class="w-full p-2 rounded border border-gray-300">
                        </div>
                        <div>
                            <label class="block mb-2">Constituição (C)</label>
                            <input type="number" name="C" required class="w-full p-2 rounded border border-gray-300">
                        </div>
                        <div>
                            <label class="block mb-2">Inteligência (I)</label>
                            <input type="number" name="I" required class="w-full p-2 rounded border border-gray-300">
                        </div>
                        <div>
                            <label class="block mb-2">Sabedoria (W)</label>
                            <input type="number" name="W" required class="w-full p-2 rounded border border-gray-300">
                        </div>
                        <div>
                            <label class="block mb-2">Carisma (Ch)</label>
                            <input type="number" name="Ch" required class="w-full p-2 rounded border border-gray-300">
                        </div>
                    </div>
                </div>
                
                <div class="md:col-span-2">
                    <h3 class="text-lg font-bold mb-3 section-title">ATAQUES</h3>
                    <div id="attacks-container">
                        <div class="attack-entry grid grid-cols-1 sm:grid-cols-5 gap-4 mb-4">
                            <div>
                                <label class="block mb-2">Nome</label>
                                <input type="text" name="attack-name[]" required class="w-full p-2 rounded border border-gray-300">
                            </div>
                            <div>
                                <label class="block mb-2">Bônus</label>
                                <input type="text" name="attack-bonus[]" required class="w-full p-2 rounded border border-gray-300">
                            </div>
                            <div>
                                <label class="block mb-2">Dano</label>
                                <input type="text" name="attack-damage[]" required class="w-full p-2 rounded border border-gray-300">
                            </div>
                            <div>
                                <label class="block mb-2">Efeito</label>
                                <input type="text" name="attack-effect[]" class="w-full p-2 rounded border border-gray-300">
                            </div>
                            <div class="flex items-center justify-center">
                                <button type="button" class="remove-attack-btn">
                                    <i class="fas fa-times text-red-500 hover:text-red-700"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                    <button type="button" id="add-attack" class="btn-outline py-2 px-4 rounded text-sm mt-2">
                        <i class="fas fa-plus mr-1"></i> Adicionar Ataque
                    </button>
                </div>
                
                <div class="md:col-span-2">
                    <h3 class="text-lg font-bold mb-3 section-title">HABILIDADES ESPECIAIS</h3>
                    <textarea name="special-abilities" rows="3" class="w-full p-2 rounded border border-gray-300"></textarea>
                </div>
                
                <div class="md:col-span-2 flex justify-end gap-3 mt-4">
                    <button type="button" id="cancel-form" class="btn-outline py-2 px-6 rounded">
                        Cancelar
                    </button>
                    <button type="submit" class="btn-black py-2 px-6 rounded">
                        <i class="fas fa-save mr-2"></i>Salvar Monstro
                    </button>
                </div>
            </form>
        </div>

        <!-- Área de resultado da rolagem de dados -->
        <div id="dice-result" class="hidden fixed top-4 right-4 dice-result-box rounded p-6 max-w-sm z-50">
            <div class="flex justify-between items-start mb-4">
                <h3 class="text-lg font-bold section-title">
                    RESULTADO DA ROLAGEM
                </h3>
                <button id="close-dice-result" class="text-gray-500 hover:text-gray-700">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div id="result-content" class="mt-2"></div>
        </div>

        <!-- Seção de Combate -->
        <div id="combat-section" class="combat-section rounded mb-8">
            <div class="combat-header p-4 rounded-t flex justify-between items-center">
                <h2 class="text-xl font-bold text-white">
                    <i class="fas fa-swords mr-2"></i>CONTROLE DE COMBATE
                </h2>
                <div class="flex gap-2">
                    <button id="clear-combat" class="btn-outline bg-white py-1 px-3 rounded text-sm">
                        Limpar Combate
                    </button>
                </div>
            </div>
            <div id="combat-monsters" class="p-4">
                <p id="no-combat-message" class="text-gray-600 text-center py-4">
                    Nenhum monstro em combate. Adicione monstros usando o botão "Adicionar ao Combate".
                </p>
                <!-- Os monstros em combate serão listados aqui -->
            </div>
        </div>

        <!-- Lista de monstros -->
        <div id="monsters-container" class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <!-- Os monstros serão renderizados aqui pelo JavaScript -->
        </div>
    </div>

    <script>
        // Exportar monstros para arquivo JSON
        document.addEventListener('DOMContentLoaded', function() {
            const exportBtn = document.getElementById('exportBtn');
            const importBtn = document.getElementById('importBtn');
            const importInput = document.getElementById('importInput');
            exportBtn.addEventListener('click', function() {
                const data = localStorage.getItem('shadowdark-bestiary');
                if (data) {
                    const blob = new Blob([data], { type: 'application/json' });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = 'monstros-shadowdark.json';
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);
                } else {
                    alert('Nenhum monstro encontrado para exportar.');
                }
            });
            importBtn.addEventListener('click', function() {
                importInput.value = '';
                importInput.click();
            });
            importInput.addEventListener('change', function(event) {
                const file = event.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        const monstros = JSON.parse(e.target.result);
                        if (!Array.isArray(monstros)) throw new Error('Formato inválido');
                        localStorage.setItem('shadowdark-bestiary', JSON.stringify(monstros));
                        window.location.reload();
                    } catch (err) {
                        alert('Arquivo inválido!');
                    }
                };
                reader.readAsText(file);
            });
        });
        // Dados iniciais do bestiário
        let bestiary = JSON.parse(localStorage.getItem('shadowdark-bestiary')) || [
            {
                id: 1,
                name: "Basilisco",
                description: "Lagartos musculosos com seis patas e pele cinza resistente. Seu olhar pode petrificar criaturas.",
                ac: 14,
                hp: 25,
                maxHp: 25,
                attacks: [
                    { name: "Mordida", bonus: "+4", damage: "2d6", effect: "petrificar" }
                ],
                mv: "Perto",
                attributes: {
                    S: "+3",
                    D: "+1",
                    C: "+3",
                    I: "-3",
                    W: "+1",
                    Ch: "-3"
                },
                al: "N",
                lv: 5,
                specialAbilities: "Petrificar: Qualquer criatura que tocar o basilisco ou encontrar seu olhar, CD 15 CON ou ficará petrificada.",
                isFavorite: true
            },
            {
                id: 2,
                name: "Goblin",
                description: "Pequenos humanoides verdes com orelhas pontudas e natureza travessa. Vivem em grupos.",
                ac: 12,
                hp: 7,
                maxHp: 7,
                attacks: [
                    { name: "Adaga", bonus: "+2", damage: "1d4", effect: "" }
                ],
                mv: "Perto",
                attributes: {
                    S: "-1",
                    D: "+1",
                    C: "0",
                    I: "0",
                    W: "0",
                    Ch: "-1"
                },
                al: "C",
                lv: 1,
                specialAbilities: "Furtividade: +4 em testes de Furtividade em áreas de escuridão ou vegetação densa.",
                isFavorite: false
            }
        ];

        // Salvar bestiário no localStorage
        function saveBestiary() {
            localStorage.setItem('shadowdark-bestiary', JSON.stringify(bestiary));
        }

        // Monstros em combate
        let combatMonsters = [];
        let combatInstanceCounter = 1;

        // Referências do DOM
        const monstersContainer = document.getElementById('monsters-container');
        const searchInput = document.getElementById('search');
        const monsterForm = document.getElementById('monster-form');
        const monsterFormContainer = document.getElementById('monster-form-container');
        const showFormBtn = document.getElementById('show-form-btn');
        const cancelFormBtn = document.getElementById('cancel-form');
        const addAttackBtn = document.getElementById('add-attack');
        const attacksContainer = document.getElementById('attacks-container');
        const toggleFavoritesBtn = document.getElementById('toggle-favorites');
        const diceResult = document.getElementById('dice-result');
        const resultContent = document.getElementById('result-content');
        const closeDiceResult = document.getElementById('close-dice-result');
        const combatSection = document.getElementById('combat-section');
        const combatMonstersContainer = document.getElementById('combat-monsters');
        const noCombatMessage = document.getElementById('no-combat-message');
        const clearCombatBtn = document.getElementById('clear-combat');
        const formTitle = document.getElementById('form-title');
        const editIdInput = document.getElementById('edit-id');

        // Estado da aplicação
        let showFavoritesOnly = false;
        let nextId = bestiary.length > 0 ? Math.max(...bestiary.map(m => m.id)) + 1 : 3;

        // Funções
        function renderMonsters() {
            monstersContainer.innerHTML = '';
            
            // Filtrar monstros
            let filteredMonsters = bestiary.filter(monster => {
                const matchesSearch = monster.name.toLowerCase().includes(searchInput.value.toLowerCase());
                const matchesFavorite = !showFavoritesOnly || monster.isFavorite;
                return matchesSearch && matchesFavorite;
            });
            
            // Ordenar favoritos primeiro
            filteredMonsters.sort((a, b) => {
                if (a.isFavorite && !b.isFavorite) return -1;
                if (!a.isFavorite && b.isFavorite) return 1;
                return a.name.localeCompare(b.name);
            });
            
            // Renderizar monstros
            filteredMonsters.forEach(monster => {
                const combatInstances = combatMonsters.filter(m => m.originalId === monster.id).length;
                
                const monsterCard = document.createElement('div');
                monsterCard.className = `monster-card rounded ${monster.isFavorite ? 'favorite' : ''}`;
                monsterCard.innerHTML = `
                    <div class="p-5">
                        <div class="flex justify-between items-start">
                            <div>
                                <h3 class="text-xl font-bold monster-name">${monster.name}</h3>
                                <div class="flex items-center mt-1">
                                    <span class="text-xs bg-gray-100 px-2 py-1 rounded mr-2 monster-level">Nível ${monster.lv}</span>
                                    <span class="text-xs bg-gray-100 px-2 py-1 rounded monster-level">${monster.al}</span>
                                    ${combatInstances > 0 ? 
                                        `<span class="combat-indicator text-xs">${combatInstances} em combate</span>` : 
                                        ''}
                                </div>
                            </div>
                            <div class="flex gap-1">
                                <button class="favorite-btn ${monster.isFavorite ? 'text-gray-800' : 'text-gray-400'} hover:text-gray-800" data-id="${monster.id}">
                                    <i class="${monster.isFavorite ? 'fas' : 'far'} fa-star"></i>
                                </button>
                                <button class="combat-btn ml-2 text-gray-800 hover:text-gray-600" data-id="${monster.id}">
                                    <i class="fas fa-swords"></i>
                                </button>
                            </div>
                        </div>
                        
                        <p class="mt-3 text-gray-700">${monster.description}</p>
                        
                        <div class="grid grid-cols-2 gap-3 mt-4">
                            <div class="bg-gray-50 p-3 rounded border border-gray-200">
                                <div class="text-xs text-gray-600 attribute-label">CA</div>
                                <div class="text-xl font-bold">${monster.ac}</div>
                            </div>
                            <div class="bg-gray-50 p-3 rounded border border-gray-200">
                                <div class="text-xs text-gray-600 attribute-label">PV</div>
                                <div class="text-xl font-bold">${monster.hp}</div>
                            </div>
                        </div>
                        
                        <div class="mt-4">
                            <h4 class="font-bold text-gray-800 mb-2 section-title">ATRIBUTOS</h4>
                            <div class="grid grid-cols-6 gap-2">
                                ${Object.entries(monster.attributes).map(([key, value]) => `
                                    <div class="text-center">
                                        <div class="text-xs text-gray-600 attribute-label">${key}</div>
                                        <div class="stat-circle mx-auto" data-modifier="${value}">${value}</div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                        
                        <div class="mt-4">
                            <h4 class="font-bold text-gray-800 mb-2 section-title">ATAQUES</h4>
                            <div class="space-y-2">
                                ${monster.attacks.map(attack => `
                                    <div class="flex justify-between items-center bg-gray-50 p-2 rounded border border-gray-200">
                                        <div>
                                            <div class="font-medium attack-name">${attack.name} ${attack.bonus}</div>
                                            <div class="text-sm text-gray-700">${attack.damage} ${attack.effect ? `+ ${attack.effect}` : ''}</div>
                                        </div>
                                        <button class="attack-btn py-1 px-3 rounded text-sm" 
                                                data-name="${attack.name}" 
                                                data-bonus="${attack.bonus}" 
                                                data-damage="${attack.damage}"
                                                data-effect="${attack.effect}">
                                            <i class="fas fa-dice-d20 mr-1"></i>Atacar
                                        </button>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                        
                        <div class="mt-4">
                            <h4 class="font-bold text-gray-800 mb-2 section-title">MOVIMENTO</h4>
                            <div class="bg-gray-50 p-2 rounded border border-gray-200 text-gray-700">${monster.mv}</div>
                        </div>
                        
                        ${monster.specialAbilities ? `
                        <div class="mt-4">
                            <h4 class="font-bold text-gray-800 mb-2 section-title">HABILIDADES ESPECIAIS</h4>
                            <div class="special-ability p-3 rounded text-gray-700">${monster.specialAbilities}</div>
                        </div>
                        ` : ''}
                        
                        <div class="monster-actions">
                            <button class="combat-btn-large btn-black w-full py-2 rounded flex items-center justify-center mb-2" data-id="${monster.id}">
                                <i class="fas fa-swords mr-2"></i>Adicionar ao Combate
                            </button>
                            
                            <div class="flex justify-between">
                                <button class="edit-btn py-1 px-3 rounded flex items-center" data-id="${monster.id}">
                                    <i class="fas fa-edit mr-1"></i> Editar
                                </button>
                                <button class="delete-btn py-1 px-3 rounded flex items-center" data-id="${monster.id}">
                                    <i class="fas fa-trash mr-1"></i> Deletar
                                </button>
                            </div>
                        </div>
                    </div>
                `;
                monstersContainer.appendChild(monsterCard);
            });
            
            // Adicionar event listeners
            document.querySelectorAll('.favorite-btn').forEach(btn => {
                btn.addEventListener('click', () => toggleFavorite(btn.dataset.id));
            });
            
            document.querySelectorAll('.attack-btn').forEach(btn => {
                btn.addEventListener('click', () => rollAttack(
                    btn.dataset.name,
                    btn.dataset.bonus,
                    btn.dataset.damage,
                    btn.dataset.effect
                ));
            });
            
            document.querySelectorAll('.combat-btn').forEach(btn => {
                btn.addEventListener('click', () => addToCombat(btn.dataset.id));
            });
            
            document.querySelectorAll('.combat-btn-large').forEach(btn => {
                btn.addEventListener('click', () => addToCombat(btn.dataset.id));
            });
            
            document.querySelectorAll('.edit-btn').forEach(btn => {
                btn.addEventListener('click', () => editMonster(btn.dataset.id));
            });
            
            document.querySelectorAll('.delete-btn').forEach(btn => {
                btn.addEventListener('click', () => deleteMonster(btn.dataset.id));
            });
            
            // Adicionar event listeners para rolagem de atributos
            document.querySelectorAll('.stat-circle').forEach(circle => {
                circle.addEventListener('click', () => rollAttributeCheck(circle.dataset.modifier));
            });
        }

        function renderCombatSection() {
            if (combatMonsters.length === 0) {
                noCombatMessage.classList.remove('hidden');
                combatMonstersContainer.innerHTML = '';
                return;
            }
            
            noCombatMessage.classList.add('hidden');
            let combatHTML = '';
            
            combatMonsters.forEach(monster => {
                combatHTML += `
                    <div class="combat-monster p-3">
                        <div class="flex justify-between items-center mb-2">
                            <div>
                                <h3 class="font-bold text-lg">${monster.name} <span class="combat-instance-id">#${monster.instanceId}</span></h3>
                                <div class="text-sm text-gray-600">Nível ${monster.lv} | CA: ${monster.ac}</div>
                            </div>
                            <button class="remove-combat-btn text-gray-500 hover:text-gray-700" data-instance="${monster.instanceId}">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                        
                        <div class="flex items-center gap-3 mb-2">
                            <div class="font-medium">PV:</div>
                            <div class="hp-control flex items-center rounded">
                                <button class="hp-btn decrease-hp px-3 py-1 text-gray-700 hover:bg-gray-100" data-instance="${monster.instanceId}" data-change="-5">-5</button>
                                <button class="hp-btn decrease-hp px-3 py-1 text-gray-700 hover:bg-gray-100" data-instance="${monster.instanceId}" data-change="-1">-1</button>
                                <input type="number" class="current-hp w-16 text-center p-1 border-x border-gray-300" 
                                    value="${monster.hp}" min="0" max="${monster.maxHp}" data-instance="${monster.instanceId}">
                                <button class="hp-btn increase-hp px-3 py-1 text-gray-700 hover:bg-gray-100" data-instance="${monster.instanceId}" data-change="1">+1</button>
                                <button class="hp-btn increase-hp px-3 py-1 text-gray-700 hover:bg-gray-100" data-instance="${monster.instanceId}" data-change="5">+5</button>
                            </div>
                            <div class="text-sm text-gray-600">/${monster.maxHp}</div>
                        </div>
                        
                        <div class="combat-actions">
                            <div class="attack-dropdown">
                                <button class="btn-black py-1 px-3 rounded text-sm flex items-center">
                                    <i class="fas fa-dice-d20 mr-1"></i> Atacar
                                </button>
                                <div class="attack-dropdown-content">
                                    ${monster.attacks.map(attack => `
                                        <a href="#" data-name="${attack.name}" 
                                           data-bonus="${attack.bonus}" 
                                           data-damage="${attack.damage}"
                                           data-effect="${attack.effect}">
                                            ${attack.name} (${attack.damage})
                                        </a>
                                    `).join('')}
                                </div>
                            </div>
                            
                            <button class="reset-hp-btn btn-outline py-1 px-3 rounded text-sm flex items-center" data-instance="${monster.instanceId}">
                                <i class="fas fa-redo mr-1"></i> Resetar PV
                            </button>
                        </div>
                    </div>
                `;
            });
            
            combatMonstersContainer.innerHTML = combatHTML;
            
            // Adicionar event listeners para os controles de combate
            document.querySelectorAll('.remove-combat-btn').forEach(btn => {
                btn.addEventListener('click', () => removeFromCombat(btn.dataset.instance));
            });
            
            document.querySelectorAll('.hp-btn').forEach(btn => {
                btn.addEventListener('click', () => updateCombatHP(
                    btn.dataset.instance,
                    parseInt(btn.dataset.change)
                ));
            });
            
            document.querySelectorAll('.current-hp').forEach(input => {
                input.addEventListener('change', (e) => {
                    const newHP = parseInt(e.target.value) || 0;
                    updateCombatHP(e.target.dataset.instance, newHP, true);
                });
            });
            
            document.querySelectorAll('.reset-hp-btn').forEach(btn => {
                btn.addEventListener('click', () => resetCombatHP(btn.dataset.instance));
            });
            
            document.querySelectorAll('.attack-dropdown-content a').forEach(link => {
                link.addEventListener('click', (e) => {
                    e.preventDefault();
                    rollAttack(
                        link.dataset.name,
                        link.dataset.bonus,
                        link.dataset.damage,
                        link.dataset.effect
                    );
                });
            });
        }

        function addToCombat(monsterId) {
            const monster = bestiary.find(m => m.id == monsterId);
            if (!monster) return;
            
            // Criar uma cópia do monstro para o combate
            const combatMonster = {
                ...monster,
                originalId: monster.id,
                instanceId: combatInstanceCounter++,
                hp: monster.hp
            };
            combatMonsters.push(combatMonster);
            
            renderCombatSection();
            renderMonsters();
            saveBestiary();
        }

        function removeFromCombat(instanceId) {
            combatMonsters = combatMonsters.filter(m => m.instanceId != instanceId);
            renderCombatSection();
            renderMonsters();
            saveBestiary();
        }

        function updateCombatHP(instanceId, change, isAbsolute = false) {
            const monster = combatMonsters.find(m => m.instanceId == instanceId);
            if (!monster) return;
            
            if (isAbsolute) {
                monster.hp = Math.max(0, Math.min(monster.maxHp, change));
            } else {
                monster.hp = Math.max(0, Math.min(monster.maxHp, monster.hp + change));
            }
            
            renderCombatSection();
            saveBestiary();
        }

        function resetCombatHP(instanceId) {
            const monster = combatMonsters.find(m => m.instanceId == instanceId);
            if (!monster) return;
            
            const original = bestiary.find(m => m.id == monster.originalId);
            if (!original) return;
            
            monster.hp = original.hp;
            renderCombatSection();
            saveBestiary();
        }

        function clearCombat() {
            combatMonsters = [];
            combatInstanceCounter = 1;
            renderCombatSection();
            renderMonsters();
            saveBestiary();
        }

        function toggleFavorite(monsterId) {
            const monster = bestiary.find(m => m.id == monsterId);
            if (monster) {
                monster.isFavorite = !monster.isFavorite;
                renderMonsters();
                saveBestiary();
            }
        }

        function rollAttributeCheck(modifierText) {
            // Converter o texto do modificador para número
            const modifier = parseInt(modifierText) || 0;
            const roll = Math.floor(Math.random() * 20) + 1;
            const total = roll + modifier;
            
            // Exibir o resultado
            diceResult.classList.remove('hidden');
            resultContent.innerHTML = `
                <div class="mb-4">
                    <div class="text-lg font-bold text-gray-800 mb-3">Teste de Atributo</div>
                    <div class="p-3 bg-gray-50 rounded border border-gray-200">
                        <div class="text-center">
                            <div class="dice-total">${total}</div>
                            <div class="text-sm text-gray-600">Rolagem: ${roll} + Modificador: ${modifier}</div>
                        </div>
                    </div>
                </div>
            `;
        }

        function editMonster(monsterId) {
            const monster = bestiary.find(m => m.id == monsterId);
            if (!monster) return;
            
            // Preencher o formulário com os dados do monstro
            document.querySelector('input[name="name"]').value = monster.name;
            document.querySelector('textarea[name="description"]').value = monster.description;
            document.querySelector('input[name="ac"]').value = monster.ac;
            document.querySelector('input[name="hp"]').value = monster.hp;
            document.querySelector('input[name="lv"]').value = monster.lv;
            document.querySelector('select[name="al"]').value = monster.al;
            document.querySelector('input[name="mv"]').value = monster.mv;
            
            // Preencher atributos
            Object.entries(monster.attributes).forEach(([key, value]) => {
                document.querySelector(`input[name="${key}"]`).value = value;
            });
            
            // Preencher ataques
            attacksContainer.innerHTML = '';
            monster.attacks.forEach(attack => {
                const attackEntry = document.createElement('div');
                attackEntry.className = 'attack-entry grid grid-cols-1 sm:grid-cols-5 gap-4 mb-4';
                attackEntry.innerHTML = `
                    <div>
                        <label class="block mb-2">Nome</label>
                        <input type="text" name="attack-name[]" value="${attack.name}" required class="w-full p-2 rounded border border-gray-300">
                    </div>
                    <div>
                        <label class="block mb-2">Bônus</label>
                        <input type="text" name="attack-bonus[]" value="${attack.bonus}" required class="w-full p-2 rounded border border-gray-300">
                    </div>
                    <div>
                        <label class="block mb-2">Dano</label>
                        <input type="text" name="attack-damage[]" value="${attack.damage}" required class="w-full p-2 rounded border border-gray-300">
                    </div>
                    <div>
                        <label class="block mb-2">Efeito</label>
                        <input type="text" name="attack-effect[]" value="${attack.effect || ''}" class="w-full p-2 rounded border border-gray-300">
                    </div>
                    <div class="flex items-center justify-center">
                        <button type="button" class="remove-attack-btn">
                            <i class="fas fa-times text-red-500 hover:text-red-700"></i>
                        </button>
                    </div>
                `;
                attacksContainer.appendChild(attackEntry);
                
                // Adicionar event listener para remover o ataque
                attackEntry.querySelector('.remove-attack-btn').addEventListener('click', function() {
                    attackEntry.remove();
                });
            });
            
            // Preencher habilidades especiais
            document.querySelector('textarea[name="special-abilities"]').value = monster.specialAbilities || '';
            
            // Configurar para edição
            editIdInput.value = monster.id;
            formTitle.textContent = 'EDITAR MONSTRO';
            monsterFormContainer.classList.remove('hidden');
        }

        function deleteMonster(monsterId) {
            if (!confirm('Tem certeza que deseja deletar este monstro? Esta ação não pode ser desfeita.')) {
                return;
            }
            
            bestiary = bestiary.filter(m => m.id != monsterId);
            combatMonsters = combatMonsters.filter(m => m.originalId != monsterId);
            
            renderMonsters();
            renderCombatSection();
            saveBestiary();
        }

        function rollAttack(name, bonus, damage, effect) {
            // Converter o bônus para número
            const bonusValue = parseInt(bonus.replace('+', ''));
            
            // Rolagem do d20
            const attackRoll = Math.floor(Math.random() * 20) + 1;
            const totalAttack = attackRoll + bonusValue;
            
            // Calcular dano
            let damageResult = 0;
            let damageDetails = '';
            let damageRolls = [];
            
            if (damage.includes('d')) {
                const damageParts = damage.split('+');
                const diceExpression = damageParts[0].trim();
                const extraDamage = damageParts[1] ? parseInt(damageParts[1].trim()) : 0;
                
                const [diceCount, diceSides] = diceExpression.split('d').map(Number);
                damageDetails = `${diceCount}d${diceSides}`;
                
                if (extraDamage) {
                    damageDetails += ` + ${extraDamage}`;
                }
                
                for (let i = 0; i < diceCount; i++) {
                    const roll = Math.floor(Math.random() * diceSides) + 1;
                    damageRolls.push(roll);
                    damageResult += roll;
                }
                damageResult += extraDamage;
            } else {
                damageResult = parseInt(damage) || 0;
                damageDetails = damage;
            }
            
            // Exibir resultado
            diceResult.classList.remove('hidden');
            
            let damageRollsText = '';
            if (damageRolls.length > 0) {
                damageRollsText = ` (${damageRolls.join(' + ')})`;
            }
            
            resultContent.innerHTML = `
                <div class="mb-4">
                    <div class="text-lg font-bold text-gray-800 mb-3">${name}</div>
                    
                    <div class="mb-4 p-3 bg-gray-50 rounded border border-gray-200">
                        <div class="font-bold text-gray-700 mb-2">ROLAGEM DE ATAQUE</div>
                        <div class="text-center">
                            <div class="dice-total">${totalAttack}</div>
                            <div class="text-sm text-gray-600">${attackRoll} + ${bonusValue}</div>
                        </div>
                    </div>
                    
                    <div class="p-3 bg-gray-50 rounded border border-gray-200">
                        <div class="font-bold text-gray-700 mb-2">ROLAGEM DE DANO</div>
                        <div class="text-center">
                            <div class="dice-total">${damageResult}</div>
                            <div class="text-sm text-gray-600">${damageDetails}${damageRollsText}</div>
                        </div>
                    </div>
                    
                    ${effect ? `
                    <div class="mt-4 p-3 bg-gray-50 rounded border border-gray-200">
                        <div class="font-bold text-gray-700 mb-2">EFEITO ESPECIAL</div>
                        <div>${effect}</div>
                    </div>
                    ` : ''}
                    
                    <div class="mt-4 text-center text-sm text-gray-600 italic">
                        O ataque acerta se ${totalAttack} ≥ CA do alvo
                    </div>
                </div>
            `;
        }

        function saveMonster(monsterData) {
            // Converter dados do formulário para o formato de monstro
            const attacks = [];
            const attackNames = monsterData.getAll('attack-name[]');
            const attackBonuses = monsterData.getAll('attack-bonus[]');
            const attackDamages = monsterData.getAll('attack-damage[]');
            const attackEffects = monsterData.getAll('attack-effect[]');
            
            for (let i = 0; i < attackNames.length; i++) {
                attacks.push({
                    name: attackNames[i],
                    bonus: attackBonuses[i],
                    damage: attackDamages[i],
                    effect: attackEffects[i]
                });
            }
            
            // Verificar se é uma edição ou novo monstro
            const editId = monsterData.get('edit-id');
            
            if (editId) {
                // Atualizar monstro existente
                const index = bestiary.findIndex(m => m.id == editId);
                if (index !== -1) {
                    bestiary[index] = {
                        ...bestiary[index],
                        name: monsterData.get('name'),
                        description: monsterData.get('description'),
                        ac: parseInt(monsterData.get('ac')),
                        hp: parseInt(monsterData.get('hp')),
                        maxHp: parseInt(monsterData.get('hp')),
                        attacks: attacks,
                        mv: monsterData.get('mv'),
                        attributes: {
                            S: monsterData.get('S'),
                            D: monsterData.get('D'),
                            C: monsterData.get('C'),
                            I: monsterData.get('I'),
                            W: monsterData.get('W'),
                            Ch: monsterData.get('Ch')
                        },
                        al: monsterData.get('al'),
                        lv: parseInt(monsterData.get('lv')),
                        specialAbilities: monsterData.get('special-abilities')
                    };
                }
            } else {
                // Criar novo monstro
                const newMonster = {
                    id: nextId++,
                    name: monsterData.get('name'),
                    description: monsterData.get('description'),
                    ac: parseInt(monsterData.get('ac')),
                    hp: parseInt(monsterData.get('hp')),
                    maxHp: parseInt(monsterData.get('hp')),
                    attacks: attacks,
                    mv: monsterData.get('mv'),
                    attributes: {
                        S: monsterData.get('S'),
                        D: monsterData.get('D'),
                        C: monsterData.get('C'),
                        I: monsterData.get('I'),
                        W: monsterData.get('W'),
                        Ch: monsterData.get('Ch')
                    },
                    al: monsterData.get('al'),
                    lv: parseInt(monsterData.get('lv')),
                    specialAbilities: monsterData.get('special-abilities'),
                    isFavorite: false
                };
                
                bestiary.push(newMonster);
            }
            
            renderMonsters();
            monsterForm.reset();
            monsterFormContainer.classList.add('hidden');
            saveBestiary();
        }

        // Event Listeners
        searchInput.addEventListener('input', renderMonsters);
        
        showFormBtn.addEventListener('click', () => {
            formTitle.textContent = 'ADICIONAR NOVO MONSTRO';
            editIdInput.value = '';
            monsterForm.reset();
            attacksContainer.innerHTML = `
                <div class="attack-entry grid grid-cols-1 sm:grid-cols-5 gap-4 mb-4">
                    <div>
                        <label class="block mb-2">Nome</label>
                        <input type="text" name="attack-name[]" required class="w-full p-2 rounded border border-gray-300">
                    </div>
                    <div>
                        <label class="block mb-2">Bônus</label>
                        <input type="text" name="attack-bonus[]" required class="w-full p-2 rounded border border-gray-300">
                    </div>
                    <div>
                        <label class="block mb-2">Dano</label>
                        <input type="text" name="attack-damage[]" required class="w-full p-2 rounded border border-gray-300">
                    </div>
                    <div>
                        <label class="block mb-2">Efeito</label>
                        <input type="text" name="attack-effect[]" class="w-full p-2 rounded border border-gray-300">
                    </div>
                    <div class="flex items-center justify-center">
                        <button type="button" class="remove-attack-btn">
                            <i class="fas fa-times text-red-500 hover:text-red-700"></i>
                        </button>
                    </div>
                </div>
            `;
            
            // Adicionar event listener para o botão de remover
            const removeBtn = attacksContainer.querySelector('.remove-attack-btn');
            removeBtn.addEventListener('click', function() {
                removeBtn.closest('.attack-entry').remove();
            });
            
            monsterFormContainer.classList.remove('hidden');
        });
        
        cancelFormBtn.addEventListener('click', () => {
            monsterFormContainer.classList.add('hidden');
        });
        
        addAttackBtn.addEventListener('click', () => {
            const attackEntry = document.createElement('div');
            attackEntry.className = 'attack-entry grid grid-cols-1 sm:grid-cols-5 gap-4 mb-4';
            attackEntry.innerHTML = `
                <div>
                    <label class="block mb-2">Nome</label>
                    <input type="text" name="attack-name[]" required class="w-full p-2 rounded border border-gray-300">
                </div>
                <div>
                    <label class="block mb-2">Bônus</label>
                    <input type="text" name="attack-bonus[]" required class="w-full p-2 rounded border border-gray-300">
                </div>
                <div>
                    <label class="block mb-2">Dano</label>
                    <input type="text" name="attack-damage[]" required class="w-full p-2 rounded border border-gray-300">
                </div>
                <div>
                    <label class="block mb-2">Efeito</label>
                    <input type="text" name="attack-effect[]" class="w-full p-2 rounded border border-gray-300">
                </div>
                <div class="flex items-center justify-center">
                    <button type="button" class="remove-attack-btn">
                        <i class="fas fa-times text-red-500 hover:text-red-700"></i>
                    </button>
                </div>
            `;
            attacksContainer.appendChild(attackEntry);
            
            // Adicionar event listener para o botão de remover
            const removeBtn = attackEntry.querySelector('.remove-attack-btn');
            removeBtn.addEventListener('click', function() {
                attackEntry.remove();
            });
        });
        
        monsterForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const formData = new FormData(monsterForm);
            saveMonster(formData);
        });
        
        toggleFavoritesBtn.addEventListener('click', () => {
            showFavoritesOnly = !showFavoritesOnly;
            toggleFavoritesBtn.innerHTML = showFavoritesOnly ? 
                '<i class="fas fa-star mr-2"></i> Mostrar Todos' : 
                '<i class="fas fa-star mr-2"></i> Favoritos';
            renderMonsters();
        });
        
        closeDiceResult.addEventListener('click', () => {
            diceResult.classList.add('hidden');
        });
        
        clearCombatBtn.addEventListener('click', clearCombat);

        // Renderizar inicialmente
        renderMonsters();
        renderCombatSection();
    </script>
</body>
</html>